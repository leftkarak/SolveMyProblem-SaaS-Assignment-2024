<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> Create Submission </title>
    <link rel="stylesheet" href="/css/create-submission.css">
</head>

<body>
<header>

    <div class="logo-container">
        <h1>Solve My Problem</h1>
        <img src="/img/540076-200.png" alt="Company Logo" class="logo-image">
        <p>Logged in as: <strong id="email"></strong></p>
    </div>

    <!-- Î›Î¿Î³ÏŒÏ„Ï…Ï€Î¿ ÎºÎ±Î¹ ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ ÏƒÏ„Î·Î½ Î¯Î´Î¹Î± Î³ÏÎ±Î¼Î¼Î® -->
    <div class="left-section">

        <div class="submissions-credits-log">

            <form id="submissionsForm">
                <button type="submit" class="submissions-btn">
                    <span class="home-icon">ğŸ›</span>
                    <span class="submissions-text">Back to Submissions</span>
                </button>
            </form>
            <form id="creditsForm">
                <button type="submit" class="credits-btn">
                    <span class="coin-icon">ğŸ’°</span>
                    <span class="credits-text">Buy/View Credits</span>
                </button>
            </form>
            <form id="analyticsForm">
                <button type="submit" class="log-btn">
                    <span class="log-icon">ğŸ“Š</span>
                    <span class="log-text">Analytics</span>
                </button>
            </form>

        </div>


        <!-- Î¤Î¯Ï„Î»Î¿Ï‚ ÏƒÏ„Î¿ ÎºÎµÎ½Ï„ÏÎ¿ ÏƒÏ‡ÎµÎ´Î¿Î½ ÏƒÏ„Î·Î½ Î¯Î´Î¹Î± Î³ÏÎ±Î¼Î¼Î® Î¼Îµ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ ÎºÎ±Î¹ email Ï„ÎµÏÎ¼Î± Î´ÎµÎ¾Î¹Î¬ -->
        <div class="right-section">
            <h2 class="page-title">ğŸ“ Create New Submission</h2>
            <div class="timestamp">
                <span id="datetime"></span>
            </div>
        </div>
    </div>
</header>

<div class="container">

    <div class="balance">
        <label for="submission_id"> Submission Name: </label>
        <input type="text" id="submission_id" placeholder="Enter name" required>
    </div>

    <form id="submissionForm" enctype="multipart/form-data">

        <label for="pyFile">Python File (.py):</label>
        <input type="file" id="pyFile" name="pyFile" accept=".py" required><br><br>

        <label for="jsonFile">JSON File (.json):</label>
        <input type="file" id="jsonFile" name="jsonFile" accept=".json" required><br><br>

        <div class="buttons">
            <button class="confirm-creation-button" id="creationButton" type="button" onclick="confirmCreation()"> Create </button>

            <button class="confirm-view-button" id="viewButton" type="button" disabled onclick="toView()"> View </button>
        </div>

    </form>
</div>

<!-- Custom Alert Modal -->
<div id="custom-alert" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAlert()">&times;</span>

        <div class="alert-message">
            <p id="alert-message"></p>
        </div>
        <button class="confirm-button" onclick="closeAlert()">OK</button>
    </div>
</div>

<script src="/js/timestamp.js"></script>
<script>
    // Header components
    // GET request to fetch email from session
    fetch('/create-submission/get-email')
        .then(response => response.json())
        .then(data => {
            document.getElementById("email").textContent = data.email;
            // Global variable email so can be accessed by function confirmCreation()
            Email = data.email;

        })
        .catch(error => {
            console.error("Error fetching email in credits.html: ", error)
        })

    // Button to go to Submissions page
    document.getElementById('submissionsForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent form submission

        fetch('/submissions')
            .then(response => {
                if (response.ok) {
                    // Redirect to submissions page on success
                    window.location.href = '/submissions';
                } else {
                    console.error('Failed to go to /submissions');
                }
            })
            .catch(error => {
                console.error('Error during loading Submissions:', error);
            });
    });

    // Action when Buy/View Credits button is pressed
    document.getElementById("creditsForm").addEventListener("submit", function(event) {
        event.preventDefault();  // Prevent default form submission

        fetch('/credits')
            .then(response => {
                if (response.ok) {
                    // Redirect to credits page on success
                    window.location.href = '/credits';
                } else {
                    console.error('Failed to go to /credits');
                }
            })
            .catch(error => {
                console.error('Error during loading credits:', error);
            });
    });

    // Button to go to Analytics page
    document.getElementById("analyticsForm").addEventListener("submit", function(event) {
        event.preventDefault();  // Prevent default form submission

        fetch('/analytics')
            .then(response => {
                if (response.ok) {
                    // Redirect to create-submission page on success
                    window.location.href = '/analytics';
                } else {
                    console.error('Failed to go to /analytics');
                }
            })
            .catch(error => {
                console.error('Error during loading analytics:', error);
            });
    });

    // Populate page
    // Global variable email so can be accessed by function confirmCreation()
    let Email;

    // Function to confirm creation
    function confirmCreation() {
        // Get metadata information
        let submission_id = document.getElementById("submission_id").value;
        let email = Email;

        // Get file inputs
        let pyFile = document.getElementById("pyFile").files[0];
        let jsonFile = document.getElementById("jsonFile").files[0];

        // Compose body using FormData
        const submission_details = new FormData();
        submission_details.append("metadata", JSON.stringify({ email: email, submission_id: submission_id })); // Append metadata as a JSON string
        submission_details.append("pyFile", pyFile); // Append the Python file
        submission_details.append("jsonFile", jsonFile); // Append the JSON file

        try {
            // POST request to update the backend using fetch
            fetch('http://localhost:4008/create-submission', {
                method: 'POST',
                body: submission_details
            })
                .then(response => {
                    if (response.ok) {
                        // If the status is 200 OK, show success alert

                        // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï… ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï "RUN" Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï„Î·Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚
                        document.getElementById("viewButton").disabled = false;

                        showAlert("Submission Confirmed!");

                    } else {
                        // If not 200 OK, handle as an error
                        throw new Error("Submission failed with status: " + response.status);
                    }
                })
                .catch(error => {
                    // Handle any errors, like network issues or non-OK status
                    console.error("Error: ", error);
                    showAlert("An error occurred: " + error.message);
                });

        } catch (error) {
            // Handle any unexpected JavaScript errors
            console.error("Unexpected error: ", error);
            showAlert("An unexpected error occurred.");
        }
    }

    // Function to go to view submission page
    function toView() {
        const creator = Email;
        const submission_id = document.getElementById("submission_id").value;

        fetch(`submission/${creator}/${submission_id}`)
            .then(response => {
                if(response.ok){
                    // Redirect to submissions page on success
                    window.location.href = `submission/${creator}/${submission_id}`;
                } else {
                    console.error("Failed to go to view submission");
                    showAlert("Cannot transfer you to page");
                }
            })
            .catch(error => {
                console.error("Error: ", error);
            });

        return null;
    }

    // // Function to run creation
    // function runCreation() {
    //     const submission_details = {
    //         "email": Email,
    //         "submission_id": document.getElementById("submission_id").value
    //     };
    //
    //     try {
    //         // POST request to execute submission using fetch
    //         fetch('http://localhost:4008/execute-submission', {
    //             method: 'POST',
    //             headers: {
    //                 "content-Type": "application/json"
    //             },
    //             body: JSON.stringify(submission_details),
    //         })
    //             .then(response => response.json())
    //             .then(data => {
    //
    //                 // If declined == TRUE , show success alert
    //                 if (data.accept) {
    //                     showAlert(" EXECUTION FAIL: \n Not enough credits to execute: " + submission_details.submission_id);
    //
    //                     // If declined == FALSE, show success alert
    //                 } else if (!data.accept) {
    //                     showAlert(" Submission: " + submission_details.submission_id + " sent to solver");
    //
    //                 }
    //
    //             })
    //             .catch(error => {
    //                 // Handle any errors, like network issues or non-OK status
    //                 console.error("Error: ", error);
    //                 showAlert("An error occurred: " + error.message);
    //             });
    //
    //     } catch (error) {
    //         // Handle any unexpected JavaScript errors
    //         console.error("Unexpected error: ", error);
    //         showAlert("An unexpected error occurred trying to execute request, in submissions.html.");
    //     }
    // }

    // Code for custom alert
    // Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Confirm ÎºÎ±Î¹ Ï„Î¿ modal
    const confirmcreationButton = document.querySelector('.confirm-creation-button');
    const modal = document.querySelector('.modal');
    const closeBtn = document.querySelector('.close-btn');

    // ÎŒÏ„Î±Î½ Ï€Î±Ï„Î·Î¸ÎµÎ¯ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Confirm", Ï„Î¿ modal Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯
    confirmcreationButton.addEventListener('click', function() {
        modal.style.display = 'flex'; // Î‘Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ modal
        modal.classList.add('show'); // Î ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Ï„Î·Î½ ÎºÎ»Î¬ÏƒÎ· Î³Î¹Î± Î¿Î¼Î±Î»Î® Î¼ÎµÏ„Î¬Î²Î±ÏƒÎ·
    });

    // ÎŒÏ„Î±Î½ Ï€Î±Ï„Î·Î¸ÎµÎ¯ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ ÎºÎ»ÎµÎ¹ÏƒÎ¯Î¼Î±Ï„Î¿Ï‚, Ï„Î¿ modal ÎºÎ»ÎµÎ¯Î½ÎµÎ¹
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none'; // ÎšÎ»ÎµÎ¯Î½ÎµÎ¹ Ï„Î¿ modal
        modal.classList.remove('show'); // Î‘Ï†Î±Î¹ÏÎµÎ¯ Ï„Î·Î½ ÎºÎ»Î¬ÏƒÎ· Î³Î¹Î± Î¿Î¼Î±Î»Î® Î¼ÎµÏ„Î¬Î²Î±ÏƒÎ·
    });

    // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Ï„Î¿Ï… modal ÏŒÏ„Î±Î½ Ï€Î±Ï„Î·Î¸ÎµÎ¯ Î¿Ï€Î¿Ï…Î´Î®Ï€Î¿Ï„Îµ Î­Î¾Ï‰ Î±Ï€ÏŒ Ï„Î¿ modal
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none'; // ÎšÎ»ÎµÎ¯Î½ÎµÎ¹ Ï„Î¿ modal
            modal.classList.remove('show'); // Î‘Ï†Î±Î¹ÏÎµÎ¯ Ï„Î·Î½ ÎºÎ»Î¬ÏƒÎ· Î³Î¹Î± Î¿Î¼Î±Î»Î® Î¼ÎµÏ„Î¬Î²Î±ÏƒÎ·
        }
    });

    // Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î³Î¹Î± Î½Î± ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ Ï„Î¿ custom alert
    function closeAlert() {
        document.getElementById("custom-alert").style.display = "none";
        // Reload the page after alert
        location.reload();
    }

    function showAlert(message) {
        document.getElementById("alert-message").innerText = message;
        document.getElementById("custom-alert").style.display = "flex"; // Î†Î¼ÎµÏƒÎ· ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·
    }
    </script>

</body>
</html>